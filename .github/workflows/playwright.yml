name: Playwright Tests

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

# Allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write
  pull-requests: write

jobs:
  playwright:
    runs-on: blacksmith-4vcpu-ubuntu-2404
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: useblacksmith/setup-node@v5
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm install

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Build
        run: npm run build

      - name: Run Playwright tests
        run: npm run test:ct
        continue-on-error: true
        id: playwright
        env:
          PLAYWRIGHT_WORKERS: 2

      - name: Upload Playwright report artifact
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 14

      - name: Upload visual snapshots artifact
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: visual-snapshots
          path: src/__tests__/playwright/__snapshots__/
          retention-days: 14
          if-no-files-found: ignore

      # Deploy report to GitHub Pages (optional - requires Pages to be enabled)
      - name: Setup Pages
        uses: actions/configure-pages@v4
        if: ${{ !cancelled() }}
        continue-on-error: true
        id: pages-setup

      - name: Prepare report for Pages
        if: ${{ !cancelled() && steps.pages-setup.outcome == 'success' }}
        run: |
          mkdir -p _site/playwright-reports/${{ github.run_id }}
          cp -r playwright-report/* _site/playwright-reports/${{ github.run_id }}/
          # Create an index with redirect to latest report
          echo '<!DOCTYPE html><html><head><meta http-equiv="refresh" content="0; url=playwright-reports/${{ github.run_id }}/"></head></html>' > _site/index.html

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        if: ${{ !cancelled() && steps.pages-setup.outcome == 'success' }}
        with:
          path: _site

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
        if: ${{ !cancelled() && steps.pages-setup.outcome == 'success' }}
        continue-on-error: true
        id: deployment

      # Comment on PR with report link
      - name: Comment PR with report link
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request' && !cancelled()
        with:
          script: |
            const runId = '${{ github.run_id }}';
            const testResult = '${{ steps.playwright.outcome }}';
            const pagesEnabled = '${{ steps.pages-setup.outcome }}' === 'success';
            const icon = testResult === 'success' ? '‚úÖ' : '‚ùå';
            const status = testResult === 'success' ? 'passed' : 'failed';

            const reportLink = pagesEnabled
              ? `üìä **[View Full Report](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/playwright-reports/${runId}/)**`
              : `üìä **[Download Report Artifact](https://github.com/${{ github.repository }}/actions/runs/${runId})**`;

            const body = `## ${icon} Playwright Test Report

            **Status:** Tests ${status}

            ${reportLink}

            <details>
            <summary>Visual Snapshots</summary>

            The report includes visual snapshots for:
            - üñ•Ô∏è Desktop showcase (all variants √ó all states)
            - üì± Mobile showcase (iPhone SE viewport)
            - üìü Tablet showcase (iPad viewport)
            - üîç Search attempts audit log
            - üîó URL citation variants

            </details>

            ---
            *Run ID: ${runId} | [Download Artifacts](https://github.com/${{ github.repository }}/actions/runs/${runId})*`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Playwright Test Report')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                comment_id: botComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }

      # Add summary to workflow run
      - name: Add test summary
        if: ${{ !cancelled() }}
        run: |
          echo "## üé≠ Playwright Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.playwright.outcome }}" == "success" ]; then
            echo "‚úÖ **All tests passed**" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Some tests failed**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Reports" >> $GITHUB_STEP_SUMMARY
          echo "- [View HTML Report](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/playwright-reports/${{ github.run_id }}/)" >> $GITHUB_STEP_SUMMARY
          echo "- [Download Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì∏ Visual Snapshots" >> $GITHUB_STEP_SUMMARY
          echo "The visual showcase tests render all citation component states:" >> $GITHUB_STEP_SUMMARY
          echo "- Desktop (1280√ó720): All variants √ó all verification states" >> $GITHUB_STEP_SUMMARY
          echo "- Mobile (375√ó667): Compact view, overflow testing" >> $GITHUB_STEP_SUMMARY
          echo "- Tablet (768√ó1024): Medium viewport" >> $GITHUB_STEP_SUMMARY
          echo "- URL citations: All 16 fetch status types" >> $GITHUB_STEP_SUMMARY
          echo "- Audit log: Failed search attempts display" >> $GITHUB_STEP_SUMMARY

      # Fail the job if tests failed
      - name: Check test results
        if: steps.playwright.outcome == 'failure'
        run: exit 1
