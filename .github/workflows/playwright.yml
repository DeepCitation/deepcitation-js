name: Playwright Tests

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      update_snapshots:
        description: 'Update visual snapshots'
        required: false
        default: 'false'
        type: boolean

# Allow deployment to GitHub Pages and snapshot updates
permissions:
  contents: write
  pages: write
  id-token: write
  pull-requests: write

jobs:
  playwright:
    runs-on: blacksmith-4vcpu-ubuntu-2404
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # For PRs, checkout the head ref to allow pushing snapshot updates
          ref: ${{ github.event_name == 'pull_request' && github.head_ref || github.ref }}
          # Need fetch-depth for pushing
          fetch-depth: 0

      - name: Setup Node.js
        uses: useblacksmith/setup-node@v5
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm install

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Build
        run: npm run build

      - name: Run Playwright tests (excluding visual snapshots)
        run: npm run test:ct -- --grep-invert "visual snapshot"
        id: playwright
        env:
          PLAYWRIGHT_WORKERS: 2

      - name: Run visual snapshot tests (non-blocking)
        run: npm run test:ct -- --grep "visual snapshot" --update-snapshots
        continue-on-error: true
        id: snapshots
        env:
          PLAYWRIGHT_WORKERS: 1

      - name: Commit updated snapshots
        # Run on pushes and PRs from the same repo (not forks, which lack write access)
        if: |
          github.event_name == 'push' ||
          (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository)
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add tests/playwright/specs/__snapshots__/
          if git diff --staged --quiet; then
            echo "No snapshot changes to commit"
          else
            git commit -m "chore: Auto-update Playwright visual snapshots [skip ci]"
            # For PRs, push to the PR branch; for pushes, push to the current branch
            if [ "${{ github.event_name }}" == "pull_request" ]; then
              git push origin HEAD:${{ github.head_ref }}
            else
              git push
            fi
          fi

      - name: Upload Playwright report artifact
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 14

      - name: Upload visual snapshots artifact
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: visual-snapshots
          path: tests/playwright/specs/__snapshots__/
          retention-days: 14
          if-no-files-found: ignore

      # Deploy report to GitHub Pages (optional - requires Pages to be enabled)
      - name: Setup Pages
        uses: actions/configure-pages@v4
        if: ${{ !cancelled() }}
        continue-on-error: true
        id: pages-setup

      - name: Prepare report for Pages
        if: ${{ !cancelled() && steps.pages-setup.outcome == 'success' }}
        run: |
          mkdir -p _site/playwright-reports/${{ github.run_id }}
          cp -r playwright-report/* _site/playwright-reports/${{ github.run_id }}/

          # Copy visual snapshots to Pages
          mkdir -p _site/playwright-reports/${{ github.run_id }}/snapshots
          if [ -d "tests/playwright/specs/__snapshots__" ]; then
            cp -r tests/playwright/specs/__snapshots__/* _site/playwright-reports/${{ github.run_id }}/snapshots/ 2>/dev/null || true
          fi

          # Create a snapshots gallery page
          cat > _site/playwright-reports/${{ github.run_id }}/snapshots/index.html << 'GALLERY_EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Visual Snapshots Gallery</title>
            <style>
              body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
              h1 { color: #333; }
              .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 20px; }
              .snapshot { background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden; }
              .snapshot img { width: 100%; height: auto; display: block; cursor: zoom-in; }
              .snapshot:hover img { transform: scale(1.02); transition: transform 0.2s; }
              .snapshot-title { padding: 12px 16px; font-weight: 500; color: #333; border-top: 1px solid #eee; font-size: 14px; }
              .back-link { display: inline-block; margin-bottom: 20px; color: #0066cc; text-decoration: none; }
              .back-link:hover { text-decoration: underline; }
              .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; }
              .modal.active { display: flex; }
              .modal img { max-width: 95vw; max-height: 95vh; object-fit: contain; }
              .modal-close { position: absolute; top: 20px; right: 20px; color: white; font-size: 30px; cursor: pointer; }
            </style>
          </head>
          <body>
            <a href="../" class="back-link">‚Üê Back to Test Report</a>
            <h1>üì∏ Visual Snapshots</h1>
            <p>Click any image to view full size. These snapshots are generated from Playwright component tests.</p>
            <div class="gallery" id="gallery"></div>
            <div class="modal" id="modal" onclick="closeModal()">
              <span class="modal-close">&times;</span>
              <img id="modal-img" src="" alt="Full size snapshot">
            </div>
            <script>
              const gallery = document.getElementById('gallery');
              const extensions = ['png', 'jpg', 'jpeg'];

              // Find all PNG files in the directory (we'll populate this from the file listing)
              fetch('./')
                .then(res => res.text())
                .then(html => {
                  const parser = new DOMParser();
                  const doc = parser.parseFromString(html, 'text/html');
                  const links = Array.from(doc.querySelectorAll('a'));
                  const images = links
                    .map(a => a.getAttribute('href'))
                    .filter(href => href && extensions.some(ext => href.toLowerCase().endsWith('.' + ext)));

                  if (images.length === 0) {
                    gallery.innerHTML = '<p>No snapshots found in this directory.</p>';
                    return;
                  }

                  images.forEach(img => {
                    const name = img.replace(/\.(png|jpg|jpeg)$/i, '').replace(/-/g, ' ');
                    const div = document.createElement('div');
                    div.className = 'snapshot';
                    div.innerHTML = `
                      <img src="${img}" alt="${name}" onclick="openModal('${img}')" loading="lazy">
                      <div class="snapshot-title">${name}</div>
                    `;
                    gallery.appendChild(div);
                  });
                })
                .catch(() => {
                  gallery.innerHTML = '<p>Could not load snapshot gallery. <a href="./">Browse files directly</a></p>';
                });

              function openModal(src) {
                event.stopPropagation();
                document.getElementById('modal-img').src = src;
                document.getElementById('modal').classList.add('active');
              }

              function closeModal() {
                document.getElementById('modal').classList.remove('active');
              }

              document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
            </script>
          </body>
          </html>
          GALLERY_EOF

          # Create an index with redirect to latest report
          echo '<!DOCTYPE html><html><head><meta http-equiv="refresh" content="0; url=playwright-reports/${{ github.run_id }}/"></head></html>' > _site/index.html

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        if: ${{ !cancelled() && steps.pages-setup.outcome == 'success' }}
        with:
          path: _site

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
        if: ${{ !cancelled() && steps.pages-setup.outcome == 'success' }}
        continue-on-error: true
        id: deployment

      # Comment on PR with report link
      - name: Comment PR with report link
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request' && !cancelled()
        with:
          script: |
            const runId = '${{ github.run_id }}';
            const testResult = '${{ steps.playwright.outcome }}';
            const pagesEnabled = '${{ steps.pages-setup.outcome }}' === 'success';
            const icon = testResult === 'success' ? '‚úÖ' : '‚ùå';
            const status = testResult === 'success' ? 'passed' : 'failed';

            const baseUrl = `https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/playwright-reports/${runId}`;
            const reportLink = pagesEnabled
              ? `üìä **[View Full Report](${baseUrl}/)**`
              : `üìä **[Download Report Artifact](https://github.com/${{ github.repository }}/actions/runs/${runId})**`;

            const snapshotsLink = pagesEnabled
              ? `üì∏ **[View Visual Snapshots Gallery](${baseUrl}/snapshots/)**`
              : `üì∏ Visual snapshots available in artifacts`;

            const body = `## ${icon} Playwright Test Report

            **Status:** Tests ${status}

            ${reportLink}
            ${snapshotsLink}

            <details>
            <summary>What's in the Visual Snapshots</summary>

            The gallery includes visual snapshots for:
            - üñ•Ô∏è Desktop showcase (all variants √ó all states)
            - üì± Mobile showcase (iPhone SE viewport)
            - üìü Tablet showcase (iPad viewport)
            - üîç Popover states (verified, partial, not found)
            - üîó URL citation variants

            </details>

            ---
            *Run ID: ${runId} | [Download Artifacts](https://github.com/${{ github.repository }}/actions/runs/${runId})*`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Playwright Test Report')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                comment_id: botComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }

      # Add summary to workflow run
      - name: Add test summary
        if: ${{ !cancelled() }}
        run: |
          BASE_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/playwright-reports/${{ github.run_id }}"

          echo "## üé≠ Playwright Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.playwright.outcome }}" == "success" ]; then
            echo "‚úÖ **All tests passed**" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Some tests failed**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Reports" >> $GITHUB_STEP_SUMMARY
          echo "- [View HTML Report](${BASE_URL}/)" >> $GITHUB_STEP_SUMMARY
          echo "- [üì∏ View Visual Snapshots Gallery](${BASE_URL}/snapshots/)" >> $GITHUB_STEP_SUMMARY
          echo "- [Download Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì∏ Visual Snapshots" >> $GITHUB_STEP_SUMMARY
          echo "The visual showcase tests render all citation component states:" >> $GITHUB_STEP_SUMMARY
          echo "- Desktop (1280√ó720): All variants √ó all verification states" >> $GITHUB_STEP_SUMMARY
          echo "- Mobile (375√ó667): Compact view, overflow testing" >> $GITHUB_STEP_SUMMARY
          echo "- Tablet (768√ó1024): Medium viewport" >> $GITHUB_STEP_SUMMARY
          echo "- Popover states: Verified, partial match, not found" >> $GITHUB_STEP_SUMMARY
          echo "- URL citations: All 16 fetch status types" >> $GITHUB_STEP_SUMMARY

      # Fail the job only if functional tests failed (not visual snapshots)
      - name: Check test results
        if: steps.playwright.outcome == 'failure'
        run: |
          echo "‚ùå Functional Playwright tests failed"
          exit 1
