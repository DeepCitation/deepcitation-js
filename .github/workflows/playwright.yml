name: Playwright Tests

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      update_snapshots:
        description: 'Update visual snapshots'
        required: false
        default: 'false'
        type: boolean

# Permissions for snapshot updates and PR comments
permissions:
  contents: write
  pull-requests: write

jobs:
  playwright:
    runs-on: blacksmith-4vcpu-ubuntu-2404
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # For PRs, checkout the head ref to allow pushing snapshot updates
          ref: ${{ github.event_name == 'pull_request' && github.head_ref || github.ref }}
          # Need fetch-depth for pushing
          fetch-depth: 0

      - name: Setup Node.js
        uses: useblacksmith/setup-node@v5
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm install

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Build
        run: npm run build

      - name: Run Playwright tests (excluding visual snapshots)
        run: npm run test:ct -- --grep-invert "visual snapshot"
        id: playwright
        env:
          PLAYWRIGHT_WORKERS: 2

      - name: Run visual snapshot tests (non-blocking)
        run: npm run test:ct -- --grep "visual snapshot" --update-snapshots
        continue-on-error: true
        id: snapshots
        env:
          PLAYWRIGHT_WORKERS: 1

      - name: Convert PNG snapshots to AVIF
        run: node scripts/convert-snapshots-to-avif.js --remove-png
        continue-on-error: true

      - name: Commit updated snapshots
        # Run on pushes and PRs from the same repo (not forks, which lack write access)
        if: |
          github.event_name == 'push' ||
          (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository)
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add tests/playwright/specs/__snapshots__/
          if git diff --staged --quiet; then
            echo "No snapshot changes to commit"
          else
            git commit -m "chore: Auto-update Playwright visual snapshots [skip ci]"
            # For PRs, push to the PR branch; for pushes, push to the current branch
            if [ "${{ github.event_name }}" == "pull_request" ]; then
              git push origin HEAD:${{ github.head_ref }}
            else
              git push
            fi
          fi

      - name: Upload Playwright report artifact
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 14

      - name: Upload visual snapshots artifact
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: visual-snapshots
          path: tests/playwright/specs/__snapshots__/
          retention-days: 14
          if-no-files-found: ignore

      # Note: Playwright reports are available as artifacts only.
      # GitHub Pages is reserved for the Jekyll documentation site.

      # Comment on PR with report link
      - name: Comment PR with report link
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request' && !cancelled()
        with:
          script: |
            const runId = '${{ github.run_id }}';
            const testResult = '${{ steps.playwright.outcome }}';
            const icon = testResult === 'success' ? '‚úÖ' : '‚ùå';
            const status = testResult === 'success' ? 'passed' : 'failed';

            const artifactsUrl = `https://github.com/${{ github.repository }}/actions/runs/${runId}`;

            const body = `## ${icon} Playwright Test Report

            **Status:** Tests ${status}

            üìä **[Download Report & Snapshots](${artifactsUrl})** (see Artifacts section)

            <details>
            <summary>What's in the Visual Snapshots</summary>

            The gallery includes visual snapshots for:
            - üñ•Ô∏è Desktop showcase (all variants √ó all states)
            - üì± Mobile showcase (iPhone SE viewport)
            - üìü Tablet showcase (iPad viewport)
            - üîç Popover states (verified, partial, not found)
            - üîó URL citation variants

            </details>

            ---
            *Run ID: ${runId}*`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Playwright Test Report')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                comment_id: botComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }

      # Add summary to workflow run
      - name: Add test summary
        if: ${{ !cancelled() }}
        run: |
          ARTIFACTS_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          echo "## üé≠ Playwright Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.playwright.outcome }}" == "success" ]; then
            echo "‚úÖ **All tests passed**" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Some tests failed**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Reports" >> $GITHUB_STEP_SUMMARY
          echo "- [Download Artifacts](${ARTIFACTS_URL}) (playwright-report, visual-snapshots)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì∏ Visual Snapshots" >> $GITHUB_STEP_SUMMARY
          echo "The visual showcase tests render all citation component states:" >> $GITHUB_STEP_SUMMARY
          echo "- Desktop (1280√ó720): All variants √ó all verification states" >> $GITHUB_STEP_SUMMARY
          echo "- Mobile (375√ó667): Compact view, overflow testing" >> $GITHUB_STEP_SUMMARY
          echo "- Tablet (768√ó1024): Medium viewport" >> $GITHUB_STEP_SUMMARY
          echo "- Popover states: Verified, partial match, not found" >> $GITHUB_STEP_SUMMARY
          echo "- URL citations: All 16 fetch status types" >> $GITHUB_STEP_SUMMARY

      # Fail the job only if functional tests failed (not visual snapshots)
      - name: Check test results
        if: steps.playwright.outcome == 'failure'
        run: |
          echo "‚ùå Functional Playwright tests failed"
          exit 1
